<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµŒè·¯æ¤œç´¢ - åœ°å›³è¡¨ç¤º</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1000;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: white;
      color: #667eea;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }
    
    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    /* æ¤œç´¢ãƒãƒ¼ */
    .search-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .search-input {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      width: 300px;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .search-btn {
      padding: 10px 25px;
      background: white;
      color: #667eea;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }
    
    .search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    .clear-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.3);
      color: white;
      border: 2px solid white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .clear-btn:hover {
      background: rgba(255,255,255,0.5);
    }
    
    /* ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢ãƒãƒ¼ */
    .category-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .category-select {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      width: 300px;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      background: white;
      cursor: pointer;
    }
    
    .result-info {
      margin-top: 10px;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .loading {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.9);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    
    .loading.active {
      display: block;
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
    .main-content {
      display: flex;
      height: calc(100vh - 200px);
      position: relative;
    }
    
    /* åœ°å›³ã‚¨ãƒªã‚¢ */
    #map {
      flex: 1;
      height: 100%;
      transition: all 0.3s;
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
    .side-panel {
      width: 0;
      height: 100%;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      transition: width 0.3s;
      position: relative;
    }
    
    .side-panel.active {
      width: 400px;
    }
    
    .side-panel-content {
      padding: 0;
      display: none;
    }
    
    .side-panel.active .side-panel-content {
      display: block;
    }
    
    .panel-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .close-panel-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255,255,255,0.3);
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .close-panel-btn:hover {
      background: rgba(255,255,255,0.5);
      transform: rotate(90deg);
    }
    
    .panel-title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 8px;
      padding-right: 40px;
    }
    
    .panel-type {
      display: inline-block;
      background: rgba(255,255,255,0.3);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 13px;
    }
    
    .panel-body {
      padding: 25px;
    }
    
    /* è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .detail-section {
      margin-bottom: 25px;
      padding-bottom: 25px;
      border-bottom: 1px solid #eee;
    }
    
    .detail-section:last-child {
      border-bottom: none;
    }
    
    .detail-section-title {
      font-size: 14px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .detail-content {
      font-size: 15px;
      line-height: 1.8;
      color: #333;
    }
    
    .detail-description {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      line-height: 1.8;
      color: #555;
    }
    
    .detail-link {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-weight: bold;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .detail-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .detail-coordinates {
      display: inline-block;
      background: #f0f3ff;
      padding: 10px 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 13px;
      color: #667eea;
    }
    
    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
    .leaflet-popup-content {
      margin: 15px;
      line-height: 1.6;
      min-width: 200px;
    }
    
    .popup-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    
    .popup-type {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 3px 10px;
      border-radius: 5px;
      font-size: 12px;
      margin-bottom: 10px;
    }
    
    .popup-detail-btn {
      display: block;
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      transition: all 0.3s;
    }
    
    .popup-detail-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .side-panel.active {
        width: 100%;
        position: absolute;
        z-index: 1500;
      }
      
      .search-input {
        width: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <button class="back-btn" onclick="location.href='index.html'">â† æˆ»ã‚‹</button>
    <h1>çµŒè·¯æ¤œç´¢</h1>
    
    <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãƒãƒ¼ -->
    <div class="search-container">
      <input type="text" id="search-input" class="search-input" placeholder="ã‚¹ãƒãƒƒãƒˆåã§æ¤œç´¢(ä¾‹:å¤§é˜ªåŸã€äº¬éƒ½ã€å¯º)">
      <button class="search-btn" onclick="searchSpots()">ğŸ” æ¤œç´¢</button>
      <button class="clear-btn" onclick="clearSearch()">ã‚¯ãƒªã‚¢</button>
    </div>
    
    <!-- ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢ãƒãƒ¼ -->
    <div class="category-container">
      <select id="category-select" class="category-select">
        <option value="">-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>
        <option value="castle">åŸ</option>
        <option value="buddhist">å¯ºé™¢</option>
        <option value="shinto">ç¥ç¤¾</option>
        <option value="museum">åšç‰©é¤¨</option>
        <option value="gallery">ç¾è¡“é¤¨</option>
        <option value="theme_park">ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯</option>
        <option value="heritage">ä¸–ç•Œéºç”£</option>
        <option value="park">å…¬åœ’</option>
        <option value="theatre">åŠ‡å ´</option>
        <option value="restaurant">é£²é£Ÿåº—</option>
        <option value="library">å›³æ›¸é¤¨</option>
        <option value="cinema">æ˜ ç”»é¤¨</option>
        <option value="water_park">ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ¼ã‚¯</option>
        <option value="zoo">å‹•ç‰©åœ’</option>
        <option value="aquarium">æ°´æ—é¤¨</option>
        <option value="viewpoint">å±•æœ›å°</option>
      </select>
      <button class="search-btn" onclick="searchByCategory()">ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢</button>
    </div>
    
    <div class="result-info" id="result-info">æ¤œç´¢ã—ã¦ã‚¹ãƒãƒƒãƒˆã‚’è¡¨ç¤º</div>
    <div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
  
  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
  <div class="main-content">
    <!-- åœ°å›³ã‚¨ãƒªã‚¢ -->
    <div id="map"></div>
    
    <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
    <div class="side-panel" id="side-panel">
      <div class="side-panel-content" id="side-panel-content">
        <!-- JavaScriptã§å‹•çš„ã«å†…å®¹ã‚’æŒ¿å…¥ -->
      </div>
    </div>
  </div>
  
  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var map = L.map('map').setView([34.8, 135.5], 9);
    let markers = [];
    let currentSpot = null;
    
    // OpenStreetMapã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    // DOMè¦ç´ 
    const loading = document.getElementById('loading');
    const resultInfo = document.getElementById('result-info');
    const searchInput = document.getElementById('search-input');
    const categorySelect = document.getElementById('category-select');
    const sidePanel = document.getElementById('side-panel');
    
    // Enterã‚­ãƒ¼ã§æ¤œç´¢
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchSpots();
      }
    });
    
    // ã‚¹ãƒãƒƒãƒˆè©³ç´°ã‚’ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã«è¡¨ç¤º
    function showSpotDetail(spot) {
      currentSpot = spot;
      const detailHTML = generateDetailHTML(spot);
      
      document.getElementById('side-panel-content').innerHTML = `
        <div class="panel-header">
          <button class="close-panel-btn" onclick="closeSidePanel()">Ã—</button>
          <div class="panel-title">${spot.name}</div>
          <div class="panel-type">${spot.type}</div>
        </div>
        <div class="panel-body">
          ${detailHTML}
        </div>
      `;
      
      sidePanel.classList.add('active');
    }
    
    // è©³ç´°HTMLç”Ÿæˆ
    function generateDetailHTML(spot) {
      let html = '';
      
      // ä½æ‰€
      if (spot.address) {
        html += `
          <div class="detail-section">
            <div class="detail-section-title">ğŸ“ ä½æ‰€</div>
            <div class="detail-content">${spot.address}</div>
          </div>
        `;
      }
      
      // æ¦‚è¦
      if (spot.description) {
        html += `
          <div class="detail-section">
            <div class="detail-section-title">â„¹ï¸ æ¦‚è¦</div>
            <div class="detail-description">${spot.description}</div>
          </div>
        `;
      }
      
      // åº§æ¨™
      html += `
        <div class="detail-section">
          <div class="detail-section-title">ğŸ“Œ ä½ç½®æƒ…å ±</div>
          <div class="detail-coordinates">
            ç·¯åº¦: ${spot.lat.toFixed(6)}<br>
            çµŒåº¦: ${spot.lon.toFixed(6)}
          </div>
        </div>
      `;
      
      // ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ
      if (spot.website) {
        html += `
          <div class="detail-section">
            <div class="detail-section-title">ğŸŒ å…¬å¼ã‚µã‚¤ãƒˆ</div>
            <a href="${spot.website}" target="_blank" class="detail-link">
              å…¬å¼ã‚µã‚¤ãƒˆã‚’é–‹ã â†’
            </a>
          </div>
        `;
      }
      
      return html;
    }
    
    // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
    function closeSidePanel() {
      sidePanel.classList.remove('active');
    }
    
    // ã‚¹ãƒãƒƒãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®ã‚¢ã‚¤ã‚³ãƒ³è‰²è¨­å®š
    function getMarkerColor(type) {
      const colors = {
        'åŸ': '#8B4513',
        'å¯ºé™¢': '#FF6347',
        'ç¥ç¤¾': '#FF4500',
        'åšç‰©é¤¨': '#4682B4',
        'ç¾è¡“é¤¨': '#6A5ACD',
        'ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯': '#FF1493',
        'ä¸–ç•Œéºç”£': '#DAA520',
        'å…¬åœ’': '#32CD32',
        'åŠ‡å ´': '#A0522D',
        'é£²é£Ÿåº—': '#FFA500',
        'å›³æ›¸é¤¨': '#20B2AA',
        'æ˜ ç”»é¤¨': '#708090',
        'ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ¼ã‚¯': '#00CED1',
        'å‹•ç‰©åœ’': 'red',
        'æ°´æ—é¤¨': '#1E90FF',
        'å±•æœ›å°': '#2E8B57',
        'è¦³å…‰åœ°': '#7B68EE',
        'å¯ºç¤¾': '#B22222',
        'ãã®ä»–': '#808080',
        'other': '#808080'
      };
      return colors[type] || colors['other'];
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ä½œæˆ
    function createCustomIcon(type) {
      const color = getMarkerColor(type);
      return L.divIcon({
        className: 'custom-icon',
        html: `<div style="
          background-color: ${color};
          width: 12px;
          height: 12px;
          border-radius: 50%;
          border: 2px solid white;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [12, 12],
        iconAnchor: [6, 6]
      });
    }
    
    // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }
    
    // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
    function displayMarkers(spots, searchType) {
      if (spots.length === 0) {
        alert('è©²å½“ã™ã‚‹ã‚¹ãƒãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }
      
      spots.forEach(function(spot) {
        const icon = createCustomIcon(spot.type);
        var marker = L.marker([spot.lat, spot.lon], { icon: icon }).addTo(map);
        markers.push(marker);
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
        var popupContent = `
          <div>
            <div class="popup-title">${spot.name}</div>
            <span class="popup-type">${spot.type}</span>
            <button class="popup-detail-btn" onclick='showSpotDetail(${JSON.stringify(spot).replace(/'/g, "&apos;")})'>
              è©³ç´°ã‚’è¦‹ã‚‹
            </button>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        
        // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
        marker.on('click', function() {
          setTimeout(() => showSpotDetail(spot), 100);
        });
      });
      
      if (spots.length > 0) {
        map.setView([spots[0].lat, spots[0].lon], 12);
      }
    }
    
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢å®Ÿè¡Œ
    function searchSpots() {
      const query = searchInput.value.trim();
      
      if (!query) {
        alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      clearMarkers();
      loading.classList.add('active');
      resultInfo.textContent = 'æ¤œç´¢ä¸­...';
      
      fetch(`/api/search-spots?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(result => {
          loading.classList.remove('active');
          
          if (!result.success) {
            alert('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            resultInfo.textContent = 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ';
            return;
          }
          
          resultInfo.textContent = `ã€Œ${result.query}ã€ã®æ¤œç´¢çµæœ: ${result.count}ä»¶`;
          displayMarkers(result.spots, 'keyword');
        })
        .catch(error => {
          loading.classList.remove('active');
          console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    
    // ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢å®Ÿè¡Œ
    function searchByCategory() {
      const category = categorySelect.value;
      
      if (!category) {
        alert('ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      clearMarkers();
      loading.classList.add('active');
      resultInfo.textContent = 'ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢ä¸­...';
      
      fetch(`/api/search-by-category?category=${encodeURIComponent(category)}`)
        .then(response => response.json())
        .then(result => {
          loading.classList.remove('active');
          
          if (!result.success) {
            alert('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            resultInfo.textContent = 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ';
            return;
          }
          
          resultInfo.textContent = `ã‚«ãƒ†ã‚´ãƒªã€Œ${result.category_name}ã€ã®æ¤œç´¢çµæœ: ${result.count}ä»¶`;
          displayMarkers(result.spots, 'category');
        })
        .catch(error => {
          loading.classList.remove('active');
          console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    
    // æ¤œç´¢ã‚¯ãƒªã‚¢
    function clearSearch() {
      searchInput.value = '';
      categorySelect.value = '';
      clearMarkers();
      closeSidePanel();
      resultInfo.textContent = 'æ¤œç´¢ã—ã¦ã‚¹ãƒãƒƒãƒˆã‚’è¡¨ç¤º';
      map.setView([34.8, 135.5], 9);
    }
    
    // Overpass API ã‹ã‚‰è¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤º
    function loadOverpassSpots() {
      loading.classList.add('active');
      resultInfo.textContent = 'è¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...';

      fetch('/api/overpass-spots')
        .then(response => response.json())
        .then(result => {
          loading.classList.remove('active');
          if (result.success) {
            resultInfo.textContent = `è¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (${result.count}ä»¶)`;
            displayMarkers(result.spots, 'overpass');
          } else {
            alert(result.message);
            resultInfo.textContent = 'ã‚¹ãƒãƒƒãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
          }
        })
        .catch(error => {
          loading.classList.remove('active');
          console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ã§Overpassã‚¹ãƒãƒƒãƒˆã‚’å–å¾—
    window.addEventListener('load', loadOverpassSpots);
  </script>
</body>
</html>
