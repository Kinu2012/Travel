<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ユーザー情報編集</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .error-message {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.25rem;
      font-size: 0.875rem;
      color: #ef4444;
    }
    .success-message {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen py-8 px-4">
    <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">
          ユーザー情報編集
        </h1>

        <!-- ローディング表示 -->
        <div id="loadingMessage" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
          <div class="text-blue-600 text-sm">データを読み込み中...</div>
        </div>

        <!-- 成功メッセージ -->
        <div id="successMessage" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-md success-message">
          <div class="text-green-600 text-sm">ユーザー情報を更新しました</div>
        </div>

        <!-- エラーメッセージ -->
        <div id="errorMessage" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
          <div class="text-red-600 text-sm"></div>
        </div>

        <!-- フォーム -->
        <div id="formContainer" class="space-y-5" style="display: none;">
          <!-- 名前 -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              名前 <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              maxlength="10"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <div id="nameError" class="error-message hidden">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <span></span>
            </div>
          </div>

          <!-- メールアドレス -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              メールアドレス <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <div id="emailError" class="error-message hidden">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <span></span>
            </div>
          </div>

          <!-- 年齢 -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              年齢
            </label>
            <input
              type="number"
              id="age"
              min="0"
              max="150"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <div id="ageError" class="error-message hidden">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <span></span>
            </div>
          </div>

          <!-- パスワード変更セクション -->
          <div class="pt-4 border-t border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">
              パスワード変更（変更する場合のみ入力）
            </h2>

            <div class="space-y-4">
              <!-- 新しいパスワード -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  新しいパスワード
                </label>
                <input
                  type="password"
                  id="password"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <div id="passwordError" class="error-message hidden">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                  </svg>
                  <span></span>
                </div>
              </div>

              <!-- パスワード確認 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  パスワード確認
                </label>
                <input
                  type="password"
                  id="confirmPassword"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <div id="confirmPasswordError" class="error-message hidden">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                  </svg>
                  <span></span>
                </div>
              </div>
            </div>
          </div>

          <!-- ボタン -->
          <div class="flex gap-3 pt-4">
            <button
              id="saveBtn"
              class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              <span>保存</span>
            </button>
            <button
              id="cancelBtn"
              class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors flex items-center justify-center gap-2"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              <span>キャンセル</span>
            </button>
          </div>
        </div>
      </div>

      <!-- 注意事項 -->
      <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
        <p class="text-sm text-blue-800">
          <strong>設定情報：</strong>
        </p>
        <ul class="text-sm text-blue-700 mt-2 space-y-1 ml-4 list-disc">
          <li>API URL: <code>http://localhost:5000/api</code></li>
          <li>編集対象ユーザーID: <code id="displayUserId">1</code></li>
          <li>JavaScriptの <code>USER_ID</code> を変更することでユーザーを切り替えられます</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // ★★★ ここを変更してください ★★★
    const API_BASE_URL = 'http://localhost:5000/api';
    const USER_ID = 1; // 編集したいユーザーのID

    // 画面にユーザーIDを表示
    document.getElementById('displayUserId').textContent = USER_ID;

    // フォーム要素の取得
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const ageInput = document.getElementById('age');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const loadingMessage = document.getElementById('loadingMessage');
    const formContainer = document.getElementById('formContainer');

    // エラー要素の取得
    const nameError = document.getElementById('nameError');
    const emailError = document.getElementById('emailError');
    const ageError = document.getElementById('ageError');
    const passwordError = document.getElementById('passwordError');
    const confirmPasswordError = document.getElementById('confirmPasswordError');

    // エラーメッセージ表示
    function showApiError(message) {
      errorMessage.querySelector('div').textContent = message;
      errorMessage.classList.remove('hidden');
    }

    // エラーメッセージ非表示
    function hideApiError() {
      errorMessage.classList.add('hidden');
    }

    // ユーザーデータの読み込み
    async function loadUserData() {
      try {
        hideApiError();
        loadingMessage.classList.remove('hidden');
        formContainer.style.display = 'none';

        const response = await fetch(`${API_BASE_URL}/users/${USER_ID}`);
        
        if (!response.ok) {
          throw new Error(`ユーザーデータの取得に失敗しました (${response.status})`);
        }

        const user = await response.json();
        
        nameInput.value = user.name || '';
        emailInput.value = user.email || '';
        ageInput.value = user.age || '';

        loadingMessage.classList.add('hidden');
        formContainer.style.display = 'block';
      } catch (error) {
        console.error('データ取得エラー:', error);
        loadingMessage.classList.add('hidden');
        showApiError('ユーザーデータの読み込みに失敗しました: ' + error.message);
      }
    }

    // エラー表示
    function showError(errorElement, message) {
      errorElement.querySelector('span').textContent = message;
      errorElement.classList.remove('hidden');
      errorElement.previousElementSibling.classList.add('border-red-500');
    }

    // エラークリア
    function clearError(errorElement) {
      errorElement.classList.add('hidden');
      errorElement.previousElementSibling.classList.remove('border-red-500');
    }

    // 全エラークリア
    function clearAllErrors() {
      clearError(nameError);
      clearError(emailError);
      clearError(ageError);
      clearError(passwordError);
      clearError(confirmPasswordError);
    }

    // バリデーション
    function validateForm() {
      clearAllErrors();
      let isValid = true;

      // 名前のチェック
      if (!nameInput.value.trim()) {
        showError(nameError, '名前を入力してください');
        isValid = false;
      } else if (nameInput.value.length > 10) {
        showError(nameError, '名前は10文字以内で入力してください');
        isValid = false;
      }

      // メールアドレスのチェック
      if (!emailInput.value.trim()) {
        showError(emailError, 'メールアドレスを入力してください');
        isValid = false;
      } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
        showError(emailError, '有効なメールアドレスを入力してください');
        isValid = false;
      }

      // 年齢のチェック
      if (ageInput.value && (ageInput.value < 0 || ageInput.value > 150)) {
        showError(ageError, '有効な年齢を入力してください');
        isValid = false;
      }

      // パスワードのチェック
      if (passwordInput.value && passwordInput.value.length < 8) {
        showError(passwordError, 'パスワードは8文字以上で入力してください');
        isValid = false;
      }

      // パスワード確認のチェック
      if (passwordInput.value && passwordInput.value !== confirmPasswordInput.value) {
        showError(confirmPasswordError, 'パスワードが一致しません');
        isValid = false;
      }

      return isValid;
    }

    // 入力時のエラークリア
    [nameInput, emailInput, ageInput, passwordInput, confirmPasswordInput].forEach(input => {
      input.addEventListener('input', function() {
        const errorId = this.id + 'Error';
        const errorElement = document.getElementById(errorId);
        if (errorElement) {
          clearError(errorElement);
        }
        hideApiError();
      });
    });

    // 保存ボタンのクリックイベント
    saveBtn.addEventListener('click', async function() {
      if (!validateForm()) {
        return;
      }

      hideApiError();
      saveBtn.disabled = true;
      saveBtn.querySelector('span').textContent = '保存中...';

      // 送信データの準備
      const userData = {
        name: nameInput.value,
        email: emailInput.value,
        age: ageInput.value ? parseInt(ageInput.value) : null,
      };

      // パスワードが入力されている場合のみ追加
      if (passwordInput.value) {
        userData.password = passwordInput.value;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/users/${USER_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(userData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'ユーザー情報の更新に失敗しました');
        }

        const data = await response.json();
        
        // 成功メッセージを表示
        successMessage.classList.remove('hidden');
        
        // パスワードフィールドをクリア
        passwordInput.value = '';
        confirmPasswordInput.value = '';

        // 3秒後に成功メッセージを非表示
        setTimeout(() => {
          successMessage.classList.add('hidden');
        }, 3000);

      } catch (error) {
        console.error('保存エラー:', error);
        showApiError('保存に失敗しました: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.querySelector('span').textContent = '保存';
      }
    });

    // キャンセルボタンのクリックイベント
    cancelBtn.addEventListener('click', function() {
      window.history.back();
    });

    // ページ読み込み時にユーザーデータを取得
    loadUserData();
  </script>
</body>
</html>
