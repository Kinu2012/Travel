<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è¡Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
            color: white;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            display: none;
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .error-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>ãŠã™ã™ã‚ã‚¹ãƒãƒƒãƒˆã‚’æ¢ã—ã¦ã„ã¾ã™...</h2>
            <p>å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</p>
        </div>
    </div>

    <div class="container" id="questionnaire-screen">
        <div class="screen active">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="questionnaire-header">
                <h1>æ—…è¡Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h1>
                <p class="subtitle">æ¬¡ã®æ—…è¡Œã‚’è¨ˆç”»ã™ã‚‹ãŸã‚ã«ã€<br>ã„ãã¤ã‹ã®ç°¡å˜ãªè³ªå•ã«ç­”ãˆã¦ãã ã•ã„ï¼</p>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="error-message" id="error-message"></div>

            <!-- é€²æ—è¡¨ç¤º -->
            <div class="progress-section">
                <div class="progress-text" id="progress-text">è³ªå•ï¼‘ï¼ï¼•</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <!-- è³ªå•ãƒ•ã‚©ãƒ¼ãƒ  -->
            <form id="questionnaire-form">
                <!-- è³ªå•1 -->
                <div class="question-area active" data-question="1">
                    <h2 class="question-text">ä»Šã®æ°—åˆ†ã¯ã©ã‚“ãªæ„Ÿã˜ï¼Ÿ</h2>
                    
                    <div class="options-grid">
                        <div class="option-row">
                            <div class="mood-option">
                                <input type="radio" id="mood1" name="mood" value="excited" required>
                                <label for="mood1" class="mood-label">
                                    <span class="mood-emoji">ğŸ‰</span>
                                    <span class="mood-text">ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¦ã„ã‚‹</span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="mood2" name="mood" value="relaxed" required>
                                <label for="mood2" class="mood-label">
                                    <span class="mood-emoji">ğŸ˜Œ</span>
                                    <span class="mood-text">ã®ã‚“ã³ã‚Šã—ã¦ã„ã‚‹</span>
                                </label>
                            </div>
                        </div>

                        <div class="option-row">
                            <div class="mood-option">
                                <input type="radio" id="mood3" name="mood" value="adventurous" required>
                                <label for="mood3" class="mood-label">
                                    <span class="mood-emoji">ğŸ”ï¸</span>
                                    <span class="mood-text">å†’é™ºã—ãŸã„</span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="mood4" name="mood" value="chilled" required>
                                <label for="mood4" class="mood-label">
                                    <span class="mood-emoji">ğŸµ</span>
                                    <span class="mood-text">ã¾ã£ãŸã‚Šã—ãŸã„</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è³ªå•2 -->
                <div class="question-area" data-question="2">
                    <h2 class="question-text">æ—…è¡Œã®ç›®çš„ã¯ä½•ã§ã™ã‹ï¼Ÿ</h2>
                    
                    <div class="options-grid">
                        <div class="option-row">
                            <div class="mood-option">
                                <input type="radio" id="purpose1" name="purpose" value="relax" required>
                                <label for="purpose1" class="mood-label">
                                    <span class="mood-emoji">ğŸ–ï¸</span>
                                    <span class="mood-text">ãƒªãƒ©ãƒƒã‚¯ã‚¹</span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="purpose2" name="purpose" value="adventure" required>
                                <label for="purpose2" class="mood-label">
                                    <span class="mood-emoji">ğŸ§—</span>
                                    <span class="mood-text">ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼</span>
                                </label>
                            </div>
                        </div>

                        <div class="option-row">
                            <div class="mood-option">
                                <input type="radio" id="purpose3" name="purpose" value="culture" required>
                                <label for="purpose3" class="mood-label">
                                    <span class="mood-emoji">ğŸ¯</span>
                                    <span class="mood-text">æ–‡åŒ–ä½“é¨“</span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="purpose4" name="purpose" value="gourmet" required>
                                <label for="purpose4" class="mood-label">
                                    <span class="mood-emoji">ğŸ£</span>
                                    <span class="mood-text">ã‚°ãƒ«ãƒ¡</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è³ªå•3 -->
                <div class="question-area" data-question="3">
                    <h2 class="question-text">æ—…è¡Œã®äºˆç®—ã¯ï¼Ÿ</h2>
                    
                    <div class="options-grid">
                        <div class="option-row single-row">
                            <div class="mood-option">
                                <input type="radio" id="budget1" name="budget" value="low" required>
                                <label for="budget1" class="mood-label">
                                    <span class="mood-emoji">ğŸ’°</span>
                                    <span class="mood-text">ç¯€ç´„ã—ãŸã„<br><small>ï¼ˆ3ä¸‡å††ä»¥ä¸‹ï¼‰</small></span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="budget2" name="budget" value="medium" required>
                                <label for="budget2" class="mood-label">
                                    <span class="mood-emoji">ğŸ’µ</span>
                                    <span class="mood-text">æ™®é€š<br><small>ï¼ˆ3ã€œ8ä¸‡å††ï¼‰</small></span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="budget3" name="budget" value="high" required>
                                <label for="budget3" class="mood-label">
                                    <span class="mood-emoji">ğŸ’</span>
                                    <span class="mood-text">è´…æ²¢<br><small>ï¼ˆ8ä¸‡å††ä»¥ä¸Šï¼‰</small></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è³ªå•4 -->
                <div class="question-area" data-question="4">
                    <h2 class="question-text">æ—…è¡ŒæœŸé–“ã¯ï¼Ÿ</h2>
                    
                    <div class="options-grid">
                        <div class="option-row single-row">
                            <div class="mood-option">
                                <input type="radio" id="duration1" name="duration" value="short" required>
                                <label for="duration1" class="mood-label">
                                    <span class="mood-emoji">ğŸŒ…</span>
                                    <span class="mood-text">æ—¥å¸°ã‚Šã€œ1æ³Š</span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="duration2" name="duration" value="medium" required>
                                <label for="duration2" class="mood-label">
                                    <span class="mood-emoji">ğŸ¨</span>
                                    <span class="mood-text">2ã€œ3æ³Š</span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="duration3" name="duration" value="long" required>
                                <label for="duration3" class="mood-label">
                                    <span class="mood-emoji">âœˆï¸</span>
                                    <span class="mood-text">4æ³Šä»¥ä¸Š</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è³ªå•5 -->
                <div class="question-area" data-question="5">
                    <h2 class="question-text">åŒè¡Œè€…ã¯ï¼Ÿ</h2>
                    
                    <div class="options-grid">
                        <div class="option-row single-row">
                            <div class="mood-option">
                                <input type="radio" id="companion1" name="companion" value="solo" required>
                                <label for="companion1" class="mood-label">
                                    <span class="mood-emoji">ğŸ™‹</span>
                                    <span class="mood-text">ä¸€äººæ—…</span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="companion2" name="companion" value="couple" required>
                                <label for="companion2" class="mood-label">
                                    <span class="mood-emoji">ğŸ‘«</span>
                                    <span class="mood-text">ã‚«ãƒƒãƒ—ãƒ«</span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="companion3" name="companion" value="family" required>
                                <label for="companion3" class="mood-label">
                                    <span class="mood-emoji">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                                    <span class="mood-text">å®¶æ—</span>
                                </label>
                            </div>
                            <div class="mood-option">
                                <input type="radio" id="companion4" name="companion" value="friends" required>
                                <label for="companion4" class="mood-label">
                                    <span class="mood-emoji">ğŸ‘¥</span>
                                    <span class="mood-text">å‹äºº</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="navigation-buttons">
                    <button type="button" class="nav-btn prev-btn" id="prev-btn" disabled>
                        <span>â†</span> å‰ã¸
                    </button>
                    <button type="button" class="nav-btn next-btn" id="next-btn">
                        æ¬¡ã¸ <span>â†’</span>
                    </button>
                    <button type="submit" class="nav-btn submit-btn" id="submit-btn" style="display: none;">
                        ãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã™ã‚‹ <span>âœ¨</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            const questions = document.querySelectorAll('.question-area');
            const progressText = document.getElementById('progress-text');
            const progressFill = document.getElementById('progress-fill');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const submitBtn = document.getElementById('submit-btn');
            const form = document.getElementById('questionnaire-form');
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorMessage = document.getElementById('error-message');
            
            let currentQuestion = 0;
            const totalQuestions = questions.length;
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                console.log('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é–‹å§‹');
                
                // å›ç­”ã‚’åé›†
                const formData = new FormData(form);
                const answers = {
                    mood: formData.get('mood'),
                    purpose: formData.get('purpose'),
                    budget: formData.get('budget'),
                    duration: formData.get('duration'),
                    companion: formData.get('companion')
                };
                
                console.log('ğŸ“Š å›ç­”å†…å®¹:', answers);
                
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!answers.mood || !answers.purpose || !answers.budget || 
                    !answers.duration || !answers.companion) {
                    showError('ã™ã¹ã¦ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„');
                    return;
                }
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                loadingOverlay.classList.add('active');
                errorMessage.classList.remove('active');
                
                try {
                    // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                    const params = new URLSearchParams(answers);
                    const apiUrl = `/api/recommend?${params.toString()}`;
                    
                    console.log('ğŸŒ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('ğŸ“¡ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
                    
                    if (!data.success) {
                        throw new Error(data.message || 'ã‚¹ãƒãƒƒãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                    // â˜…â˜…â˜… æ–°å½¢å¼: ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ â˜…â˜…â˜…
                    if (data.plan) {
                        localStorage.setItem('travelPlan', JSON.stringify(data.plan));
                        console.log('ğŸ“… æ—…è¡Œãƒ—ãƒ©ãƒ³ä¿å­˜:', {
                            title: data.plan.title,
                            days: data.plan.itineraries?.length,
                            totalSpots: data.plan.summary?.total_spots
                        });
                    }
                    
                    // æ—§å½¢å¼ã‚‚ä¿å­˜ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
                    localStorage.setItem('recommendedSpots', JSON.stringify(data.spots));
                    localStorage.setItem('answers', JSON.stringify(answers));
                    localStorage.setItem('analysis', JSON.stringify(data.analysis));
                    
                    console.log('ğŸ’¾ å…¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
                    
                    // proposal.htmlã«é·ç§»
                    window.location.href = '/proposal';
                    
                } catch (error) {
                    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
                    loadingOverlay.classList.remove('active');
                    showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                }
            });
            
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.add('active');
                setTimeout(() => {
                    errorMessage.classList.remove('active');
                }, 5000);
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            nextBtn.addEventListener('click', nextQuestion);
            prevBtn.addEventListener('click', prevQuestion);
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠã®å‡¦ç†
            document.querySelectorAll('.mood-option input').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('é¸æŠå¤‰æ›´:', this.value);
                    updateNavigation();
                });
            });
            
            // è³ªå•è¡¨ç¤ºé–¢æ•°
            function showQuestion(index) {
                console.log('è³ªå•è¡¨ç¤º:', index);
                questions.forEach((q, i) => {
                    q.classList.toggle('active', i === index);
                });
                
                // é€²æ—æ›´æ–°
                const progressPercent = ((index + 1) / totalQuestions) * 100;
                progressText.textContent = `è³ªå•${index + 1}ï¼${totalQuestions}`;
                progressFill.style.width = `${progressPercent}%`;
                
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
                updateNavigation();
            }
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
            function updateNavigation() {
                const currentQuestionElement = questions[currentQuestion];
                const isAnswered = currentQuestionElement.querySelector('input:checked');
                
                // å‰ã¸ãƒœã‚¿ãƒ³
                prevBtn.disabled = currentQuestion === 0;
                
                // æ¬¡ã¸/é€ä¿¡ãƒœã‚¿ãƒ³
                if (currentQuestion === totalQuestions - 1) {
                    nextBtn.style.display = 'none';
                    submitBtn.style.display = isAnswered ? 'flex' : 'none';
                } else {
                    nextBtn.style.display = 'flex';
                    submitBtn.style.display = 'none';
                    nextBtn.disabled = !isAnswered;
                    nextBtn.style.opacity = isAnswered ? '1' : '0.7';
                    nextBtn.style.cursor = isAnswered ? 'pointer' : 'not-allowed';
                }
            }
            
            function nextQuestion() {
                const currentQuestionElement = questions[currentQuestion];
                const isAnswered = currentQuestionElement.querySelector('input:checked');
                
                if (!isAnswered) {
                    alert('é¸æŠã—ã¦ãã ã•ã„ï¼');
                    return;
                }
                
                if (currentQuestion < totalQuestions - 1) {
                    currentQuestion++;
                    showQuestion(currentQuestion);
                }
            }
            
            function prevQuestion() {
                if (currentQuestion > 0) {
                    currentQuestion--;
                    showQuestion(currentQuestion);
                }
            }
            
            // åˆæœŸè¡¨ç¤º
            showQuestion(0);
        });
    </script>
</body>
</html>
