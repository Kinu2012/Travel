<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿å­˜æ¸ˆã¿ãƒ—ãƒ©ãƒ³ä¸€è¦§</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/base.css">
    <link rel="stylesheet" href="static/page-saved-plans.css">
    <style>
        /* ä¿å­˜æ¸ˆã¿ãƒ—ãƒ©ãƒ³ä¸€è¦§ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .search-filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .status-filter {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .plan-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .plan-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .plan-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
            flex: 1;
        }

        .plan-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-draft {
            background: #fff3cd;
            color: #856404;
        }

        .status-published {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .plan-dates {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .plan-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #555;
        }

        .plan-actions {
            display: flex;
            gap: 10px;
            border-top: 1px solid #f0f0f0;
            padding-top: 15px;
        }

        .btn-edit, .btn-delete, .btn-view {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-edit {
            background: #007bff;
            color: white;
        }

        .btn-edit:hover {
            background: #0056b3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-view {
            background: #6c757d;
            color: white;
        }

        .btn-view:hover {
            background: #545b62;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .back-button-container {
            text-align: center;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="screen active">
            <div class="questionnaire-header">
                <h1>ä¿å­˜æ¸ˆã¿ãƒ—ãƒ©ãƒ³ä¸€è¦§</h1>
                <p class="subtitle">éå»ã«ä½œæˆã—ãŸæ—…è¡Œãƒ—ãƒ©ãƒ³ã®ä¸€è¦§ã§ã™</p>
            </div>
            
            <div class="search-filter-bar">
                <input type="text" id="searchInput" placeholder="ãƒ—ãƒ©ãƒ³åã§æ¤œç´¢..." class="search-input">
                <select id="statusFilter" class="status-filter">
                    <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                    <option value="draft">ä¸‹æ›¸ã</option>
                    <option value="published">å…¬é–‹</option>
                    <option value="completed">å®Œäº†</option>
                </select>
            </div>
            
            <div class="plans-grid" id="plansGrid">
                <!-- ãƒ—ãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
            
            <div class="back-button-container">
                <button onclick="location.href='edit-menu.html'" class="btn btn-secondary">ç·¨é›†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ä¿å­˜æ¸ˆã¿ãƒ—ãƒ©ãƒ³ã®ç®¡ç†
        class SavedPlansManager {
            constructor() {
                this.plans = [];
                this.filteredPlans = [];
                this.init();
            }

            async init() {
                await this.loadPlans();
                this.renderPlans();
                this.setupEventListeners();
            }

            // ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã§é–‹ç™ºé–‹å§‹ï¼‰
            async loadPlans() {
                try {
                    // TODO: å®Ÿéš›ã®APIã«ç½®ãæ›ãˆ
                    const response = await fetch('/api/plans');
                    if (response.ok) {
                        this.plans = await response.json();
                    } else {
                        // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã§é–‹ç™º
                        this.plans = this.getMockPlans();
                    }
                } catch (error) {
                    console.error('ãƒ—ãƒ©ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    this.plans = this.getMockPlans();
                }
                
                this.filteredPlans = [...this.plans];
            }

            // é–‹ç™ºç”¨ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
            getMockPlans() {
                return [
                    {
                        plan_id: 1,
                        plan_name: "äº¬éƒ½æ–‡åŒ–æ—…",
                        travel_start_date: "2024-03-01",
                        travel_end_date: "2024-03-03",
                        total_budget: 50000,
                        participant_count: 2,
                        plan_status: "draft",
                        visibility: "private",
                        created_at: "2024-01-15T10:00:00",
                        plan_data: {
                            days: [
                                {
                                    day: 1,
                                    date: "2024-03-01",
                                    activities: [
                                        { time: "09:00", location: "äº¬éƒ½é§…", activity: "åˆ°ç€", budget: 0 },
                                        { time: "10:00", location: "é‡‘é–£å¯º", activity: "è¦³å…‰", budget: 800 }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        plan_id: 2,
                        plan_name: "åŒ—æµ·é“å¤æ—…",
                        travel_start_date: "2024-07-15",
                        travel_end_date: "2024-07-20",
                        total_budget: 120000,
                        participant_count: 4,
                        plan_status: "published",
                        visibility: "private",
                        created_at: "2024-01-20T14:30:00",
                        plan_data: null
                    },
                    {
                        plan_id: 3,
                        plan_name: "æ²–ç¸„ãƒªã‚¾ãƒ¼ãƒˆ",
                        travel_start_date: "2024-05-10",
                        travel_end_date: "2024-05-15",
                        total_budget: 80000,
                        participant_count: 2,
                        plan_status: "completed",
                        visibility: "private",
                        created_at: "2024-01-25T09:15:00",
                        plan_data: {
                            days: [
                                {
                                    day: 1,
                                    date: "2024-05-10",
                                    activities: [
                                        { time: "14:00", location: "é‚£è¦‡ç©ºæ¸¯", activity: "åˆ°ç€", budget: 0 },
                                        { time: "16:00", location: "ãƒ›ãƒ†ãƒ«", activity: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³", budget: 0 }
                                    ]
                                }
                            ]
                        }
                    }
                ];
            }

            // ãƒ—ãƒ©ãƒ³ä¸€è¦§ã®è¡¨ç¤º
            renderPlans() {
                const grid = document.getElementById('plansGrid');
                
                if (this.filteredPlans.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“</div>
                            <h3>ä¿å­˜æ¸ˆã¿ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                            <p>æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
                            <button onclick="location.href='edit-category.html'" class="btn btn-primary mt-3">
                                æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ
                            </button>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = this.filteredPlans.map(plan => `
                    <div class="plan-card" data-plan-id="${plan.plan_id}">
                        <div class="plan-header">
                            <h3 class="plan-title">${plan.plan_name}</h3>
                            <span class="plan-status status-${plan.plan_status}">
                                ${this.getStatusText(plan.plan_status)}
                            </span>
                        </div>
                        <div class="plan-dates">
                            ${this.formatDate(plan.travel_start_date)} ã€œ ${this.formatDate(plan.travel_end_date)}
                        </div>
                        <div class="plan-meta">
                            <div class="meta-item">
                                <span>ğŸ’°</span>
                                <span>Â¥${plan.total_budget?.toLocaleString() || '0'}</span>
                            </div>
                            <div class="meta-item">
                                <span>ğŸ‘¥</span>
                                <span>${plan.participant_count}å</span>
                            </div>
                            <div class="meta-item">
                                <span>ğŸ“…</span>
                                <span>${this.getDuration(plan.travel_start_date, plan.travel_end_date)}æ—¥é–“</span>
                            </div>
                        </div>
                        <div class="plan-actions">
                            <button class="btn-edit" onclick="editPlan(${plan.plan_id})">ç·¨é›†</button>
                            <button class="btn-view" onclick="viewPlan(${plan.plan_id})">è©³ç´°</button>
                            <button class="btn-delete" onclick="deletePlan(${plan.plan_id})">å‰Šé™¤</button>
                        </div>
                    </div>
                `).join('');
            }

            // æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®è¨­å®š
            setupEventListeners() {
                const searchInput = document.getElementById('searchInput');
                const statusFilter = document.getElementById('statusFilter');

                searchInput.addEventListener('input', (e) => {
                    this.filterPlans(e.target.value, statusFilter.value);
                });

                statusFilter.addEventListener('change', (e) => {
                    this.filterPlans(searchInput.value, e.target.value);
                });
            }

            // ãƒ—ãƒ©ãƒ³ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
            filterPlans(searchTerm = '', status = '') {
                this.filteredPlans = this.plans.filter(plan => {
                    const matchesSearch = plan.plan_name.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesStatus = !status || plan.plan_status === status;
                    return matchesSearch && matchesStatus;
                });
                
                this.renderPlans();
            }

            // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
            getStatusText(status) {
                const statusMap = {
                    'draft': 'ä¸‹æ›¸ã',
                    'published': 'å…¬é–‹',
                    'completed': 'å®Œäº†'
                };
                return statusMap[status] || status;
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('ja-JP');
            }

            getDuration(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        function editPlan(planId) {
            location.href = `plan-editor.html?planId=${planId}`;
        }

        function viewPlan(planId) {
            // è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚„åˆ¥ãƒšãƒ¼ã‚¸ã¸
            alert(`ãƒ—ãƒ©ãƒ³ID: ${planId} ã®è©³ç´°ã‚’è¡¨ç¤º\nï¼ˆã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ï¼‰`);
        }

        async function deletePlan(planId) {
            if (confirm('ã“ã®ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nå‰Šé™¤ã—ãŸãƒ—ãƒ©ãƒ³ã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                try {
                    // TODO: å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆ
                    const response = await fetch(`/api/plans/${planId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                        location.reload();
                    } else {
                        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    // é–‹ç™ºä¸­ã¯ãƒ¢ãƒƒã‚¯å‰Šé™¤ã‚’å®Ÿè¡Œ
                    mockDeletePlan(planId);
                }
            }
        }

        // é–‹ç™ºç”¨ã®ãƒ¢ãƒƒã‚¯å‰Šé™¤é–¢æ•°
        function mockDeletePlan(planId) {
            const manager = new SavedPlansManager();
            manager.plans = manager.plans.filter(plan => plan.plan_id !== planId);
            manager.filteredPlans = manager.filteredPlans.filter(plan => plan.plan_id !== planId);
            manager.renderPlans();
            alert('ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆãƒ¢ãƒƒã‚¯æ©Ÿèƒ½ï¼‰');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new SavedPlansManager();
        });
    </script>
</body>
</html>