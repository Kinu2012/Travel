<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµŒè·¯æ¤œç´¢ - åœ°å›³è¡¨ç¤º</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
      <link rel="stylesheet" href="/static/css/map.css">
      <link rel="stylesheet" href="/static/css/review.css">
  
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <button class="back-btn" onclick="location.href='index.html'">â† æˆ»ã‚‹</button>
    <h1>çµŒè·¯æ¤œç´¢</h1>
    
    <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãƒãƒ¼ -->
    <div class="search-container">
      <input type="text" id="search-input" class="search-input" placeholder="ã‚¹ãƒãƒƒãƒˆåã§æ¤œç´¢(ä¾‹:å¤§é˜ªåŸã€äº¬éƒ½ã€å¯º)">
      <button class="search-btn" onclick="searchSpots()">ğŸ” æ¤œç´¢</button>
      <button class="clear-btn" onclick="clearSearch()">ã‚¯ãƒªã‚¢</button>
    </div>
    
    <!-- ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢ãƒãƒ¼ -->
    <div class="category-container">
      <select id="category-select" class="category-select">
        <option value="">-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>
        <option value="castle">åŸ</option>
        <option value="buddhist">å¯ºé™¢</option>
        <option value="shinto">ç¥ç¤¾</option>
        <option value="museum">åšç‰©é¤¨</option>
        <option value="gallery">ç¾è¡“é¤¨</option>
        <option value="theme_park">ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯</option>
        <option value="heritage">ä¸–ç•Œéºç”£</option>
        <option value="park">å…¬åœ’</option>
        <option value="theatre">åŠ‡å ´</option>
        <option value="restaurant">é£²é£Ÿåº—</option>
        <option value="library">å›³æ›¸é¤¨</option>
        <option value="cinema">æ˜ ç”»é¤¨</option>
        <option value="water_park">ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ¼ã‚¯</option>
        <option value="zoo">å‹•ç‰©åœ’</option>
        <option value="aquarium">æ°´æ—é¤¨</option>
        <option value="viewpoint">å±•æœ›å°</option>
      </select>
      <button class="search-btn" onclick="searchByCategory()">ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢</button>
    </div>
    
    <div class="result-info" id="result-info">æ¤œç´¢ã—ã¦ã‚¹ãƒãƒƒãƒˆã‚’è¡¨ç¤º</div>
    <div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
  
  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
  <div class="main-content">
    <!-- åœ°å›³ã‚¨ãƒªã‚¢ -->
    <div id="map">
    <!-- â˜…â˜…â˜… è·é›¢æ¸¬å®šãƒœã‚¿ãƒ³ï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰â˜…â˜…â˜… -->
      <button class="measure-btn" id="measure-btn" onclick="toggleMeasureTool(event)">
       è·é›¢æ¸¬å®š
      </button>
    </div>
    
    <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
    <div class="side-panel" id="side-panel">
      <div class="side-panel-content" id="side-panel-content">
        <!-- JavaScriptã§å‹•çš„ã«å†…å®¹ã‚’æŒ¿å…¥ -->
      </div>
    </div>
  </div>
  
  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var map = L.map('map').setView([34.8, 135.5], 9);
    let markers = [];
    //2025/11/12è¿½è¨˜
    let facilityMarkers = [];
    //ã“ã“ã ã‘
    let currentSpot = null;
    // 2025/11/13è¿½è¨˜
    // è·é›¢æ¸¬å®šãƒ„ãƒ¼ãƒ«ç”¨ã®å¤‰æ•°ï¼ˆè¿½åŠ ï¼‰
    let isMeasuring = false;
    let measurePoints = [];
    let measureLines = [];
    let measureMarkers = [];

    //ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®å¤‰æ•°
    let currentSpotForReview = null;
    let selectedRating = 0;


    // OpenStreetMapã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    // DOMè¦ç´ 
    const loading = document.getElementById('loading');
    const resultInfo = document.getElementById('result-info');
    const searchInput = document.getElementById('search-input');
    const categorySelect = document.getElementById('category-select');
    const sidePanel = document.getElementById('side-panel');
    
    // Enterã‚­ãƒ¼ã§æ¤œç´¢
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchSpots();
      }
    });
    
  // ã‚¹ãƒãƒƒãƒˆè©³ç´°ã‚’ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã«è¡¨ç¤º
function showSpotDetail(spot) {
  currentSpot = spot;
  const detailHTML = generateDetailHTML(spot);
  
  document.getElementById('side-panel-content').innerHTML = `
    <div class="panel-header">
      <button class="close-panel-btn" onclick="closeSidePanel()">Ã—</button>
      <div class="panel-title">${spot.name}</div>
      <div class="panel-type">${spot.type}</div>
    </div>
    <div class="panel-body">
      ${detailHTML}
    </div>
  `;
  
  sidePanel.classList.add('active');

  // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    setTimeout(() => {
      const reviewBtn = document.getElementById(`review-btn-${spot.id}`);
      if (reviewBtn) {
        reviewBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯:', spot); //è¿½è¨˜11/22
          openReviewModal(spot);
        });
      }
      
      // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿
      loadSpotReviews(spot.id, `reviews-container-${spot.id}`);
    }, 100);
  }
    
    // è©³ç´°HTMLç”Ÿæˆ
    function generateDetailHTML(spot) {
      let html = '';
      
      // ä½æ‰€
      if (spot.address) {
        html += `
          <div class="detail-section">
            <div class="detail-section-title">ğŸ“ ä½æ‰€</div>
            <div class="detail-content">${spot.address}</div>
          </div>
        `;
      }
      
      // æ¦‚è¦
      if (spot.description) {
        html += `
          <div class="detail-section">
            <div class="detail-section-title">â„¹ï¸ æ¦‚è¦</div>
            <div class="detail-description">${spot.description}</div>
          </div>
        `;
      }
      
      // åº§æ¨™
      html += `
        <div class="detail-section">
          <div class="detail-section-title">ğŸ“Œ ä½ç½®æƒ…å ±</div>
          <div class="detail-coordinates">
            ç·¯åº¦: ${spot.lat.toFixed(6)}<br>
            çµŒåº¦: ${spot.lon.toFixed(6)}
          </div>
        </div>
      `;
      
      // ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ
      if (spot.website) {
        html += `
          <div class="detail-section">
            <div class="detail-section-title">ğŸŒ å…¬å¼ã‚µã‚¤ãƒˆ</div>
            <a href="${spot.website}" target="_blank" class="detail-link">
              å…¬å¼ã‚µã‚¤ãƒˆã‚’é–‹ã â†’
            </a>
          </div>
        `;
      }

      //ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      html +=`
        <div class="detail-section">
          <div class="detail-section-title"> ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
          <button class="review-btn" id="review-btn-${spot.id}">
            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã™ã‚‹
          </button>
          <div id="reviews-container-${spot.id}" style="margin-top: 20px;"></div>
        </div>
      `;

      //å‘¨è¾ºæ–½è¨­ãƒœã‚¿ãƒ³é–¢é€£è¿½è¨˜2025/11/12
          html += `
        <div class="detail-section">
          <div class="detail-section-title">ğŸ” å‘¨è¾ºæ–½è¨­</div>
          <button class="nearby-btn" onclick="searchNearbyFacilities(${spot.lat}, ${spot.lon})">
            å‘¨è¾ºã®ã‚³ãƒ³ãƒ“ãƒ‹ãƒ»é§…ãƒ»ãƒˆã‚¤ãƒ¬ã‚’è¡¨ç¤º
          </button>
        </div>
      `;

      return html;
    }
    
    // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
    function closeSidePanel() {
      sidePanel.classList.remove('active');
    }

    //ã€€ã€€ã€€ã€€ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
    //ã‚»ãƒ¼ãƒ•ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ãé–¢æ•°è¿½è¨˜11/14
    function openReviewModalSafe(id,name,lat,lon,type) {
      const spot  = {
        id: id,
        name: name,
        lat: lat,
        lon: lon,
        type: type
      };
      openReviewModal(spot);
    }
//2025/11/18æ–°ã—ãå¤‰æ›´ã—ã€è¿½åŠ 
        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã 
// ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹é–¢æ•°ï¼ˆè¿½åŠ ï¼‰
async function checkLoginStatus() {
  try {
    const response = await fetch('/api/check-login', {
      credentials: 'include'
    });
    const data = await response.json();
    return data.logged_in;
  } catch (error) {
    console.error('ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}

// ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã 2025/11/22ã»ã¨ã‚“ã©å¤‰æ›´
async function openReviewModal(spot) {
  console.log('ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã - å—ã‘å–ã£ãŸspot:', spot);
  
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }

  // â˜…â˜…â˜… spotã®æ¤œè¨¼ã‚’è¿½åŠ  â˜…â˜…â˜…
  if (!spot || !spot.id || !spot.name) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒãƒƒãƒˆæƒ…å ±ãŒä¸æ­£ã§ã™', spot);
    alert('ã‚¹ãƒãƒƒãƒˆæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
  const isLoggedIn = await checkLoginStatus();
  console.log('ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯çµæœ:', isLoggedIn);
  
  if (!isLoggedIn) {
    console.warn('âš ï¸ æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹');
    if (confirm('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚\nãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) {
      window.location.href = 'login.html?redirect=map.html';
    }
    return;
  }

  //  ã“ã“ã§currentSpotForReviewã‚’è¨­å®šï¼ˆé‡è¦ï¼ï¼‰
  currentSpotForReview = spot;
  selectedRating = 0;
  
  console.log('âœ… currentSpotForReviewã‚’è¨­å®š:', currentSpotForReview);
  
  const today = new Date().toISOString().split('T')[0];
  
  const modalHTML = `
    <div class="review-modal" id="review-modal">
      <div class="review-modal-content">
        <div class="review-modal-header">
          <div class="review-modal-title">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿</div>
          <button class="review-modal-close" onclick="closeReviewModal()">Ã—</button>
        </div>
        
        <div class="review-form">
          <div class="review-form-group">
            <label>ã‚¹ãƒãƒƒãƒˆå</label>
            <input type="text" value="${spot.name}" disabled style="background: #f0f0f0;">
          </div>
          
          <div class="star-rating">
            <label>è©•ä¾¡ <span style="color: #ff6b6b;">*</span></label>
            <div class="stars" id="star-rating">
              <span class="star" data-rating="1">â˜…</span>
              <span class="star" data-rating="2">â˜…</span>
              <span class="star" data-rating="3">â˜…</span>
              <span class="star" data-rating="4">â˜…</span>
              <span class="star" data-rating="5">â˜…</span>
            </div>
            <div id="rating-display" style="margin-top: 5px; color: #666; font-size: 14px;">
              è©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„
            </div>
          </div>
          
          <div class="review-form-group">
            <label>è¨ªå•æ—¥</label>
            <input type="date" id="visit-date" max="${today}">
          </div>
          
          <div class="review-form-group">
            <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
            <textarea id="review-comment" placeholder="æ„Ÿæƒ³ã‚’æ›¸ã„ã¦ãã ã•ã„..." rows="4"></textarea>
          </div>
          
          <button class="review-submit-btn" onclick="submitReview()" id="submit-review-btn">
            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿
          </button>
        </div>
      </div>
    </div>
  `;
  
  // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
  const existingModal = document.getElementById('review-modal');
  if (existingModal) {
    existingModal.remove();
  }
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  setTimeout(() => {
    document.getElementById('review-modal').classList.add('active');
    setupStarRating();
  }, 10);
}

// æ˜Ÿè©•ä¾¡ã®è¨­å®šï¼ˆå¼·åŒ–ç‰ˆï¼‰
function setupStarRating() {
  const stars = document.querySelectorAll('.star');
  const ratingDisplay = document.getElementById('rating-display');
  
  if (!stars || stars.length === 0) {
    console.error('âŒ æ˜Ÿè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  stars.forEach(star => {
    star.addEventListener('click', function() {
      selectedRating = parseInt(this.dataset.rating);
      updateStars(selectedRating);
      
      const ratingTexts = ['', 'â˜…â˜†â˜†â˜†â˜† æ®‹å¿µ', 'â˜…â˜…â˜†â˜†â˜† ã‚¤ãƒã‚¤ãƒ', 'â˜…â˜…â˜…â˜†â˜† æ™®é€š', 'â˜…â˜…â˜…â˜…â˜† è‰¯ã„', 'â˜…â˜…â˜…â˜…â˜… æœ€é«˜'];
      if (ratingDisplay) {
        ratingDisplay.textContent = ratingTexts[selectedRating] || 'è©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„';
        ratingDisplay.style.color = '#ff6b6b';
      }
      
      console.log('â­ è©•ä¾¡é¸æŠ:', selectedRating);
    });
    
    star.addEventListener('mouseenter', function() {
      const rating = parseInt(this.dataset.rating);
      updateStars(rating);
    });
  });
  
  const starContainer = document.getElementById('star-rating');
  if (starContainer) {
    starContainer.addEventListener('mouseleave', function() {
      updateStars(selectedRating);
    });
  }
}

function updateStars(rating) {
  const stars = document.querySelectorAll('.star');
  stars.forEach((star, index) => {
    if (index < rating) {
      star.classList.add('active');
    } else {
      star.classList.remove('active');
    }
  });
}

// ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeReviewModal() {
  const modal = document.getElementById('review-modal');
  if (modal) {
    modal.classList.remove('active');
    setTimeout(() => modal.remove(), 300);
  }
  currentSpotForReview = null;
  selectedRating = 0;
  console.log('ğŸ”’ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
} //ã“ã“ã¾ã§
    
    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ 2025/11/22å¤‰æ›´
async function submitReview() {
    console.log('\n' + '='.repeat(60));
    console.log('ğŸ“¤ ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿é–‹å§‹');
    console.log('='.repeat(60));
    
    console.log('ç¾åœ¨ã®ã‚¹ãƒãƒƒãƒˆ:', currentSpotForReview);
    console.log('é¸æŠã•ã‚ŒãŸè©•ä¾¡:', selectedRating);
    console.log('Cookie:', document.cookie);
    
    if (!currentSpotForReview) {
        alert('ã‚¹ãƒãƒƒãƒˆæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        return;
    }
    
    if (selectedRating === 0) {
        alert('è©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    // â˜…â˜…â˜… æŠ•ç¨¿å‰ã«ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª â˜…â˜…â˜…
    const isLoggedIn = await checkLoginStatus();
    console.log('æŠ•ç¨¿å‰ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª:', isLoggedIn);
    
    if (!isLoggedIn) {
        alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
        window.location.reload();
        return;
    }
    
    const visitDate = document.getElementById('visit-date').value || null;
    const comment = document.getElementById('review-comment').value.trim();
    
    const reviewData = {
        osm_id: parseInt(currentSpotForReview.id),
        osm_type: 'node',
        spot_name: currentSpotForReview.name,
        spot_lat: parseFloat(currentSpotForReview.lat),
        spot_lon: parseFloat(currentSpotForReview.lon),
        spot_type: currentSpotForReview.type || 'ãã®ä»–',
        rating: parseInt(selectedRating),
        comment: comment,
        visit_date: visitDate
    };
    
    console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(reviewData, null, 2));
    
    const submitBtn = document.querySelector('.review-submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'æŠ•ç¨¿ä¸­...';
    
    try {
        console.log('ğŸ”„ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡: POST /api/reviews');
        
        const response = await fetch('/api/reviews', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json'
            },
            credentials: 'include',  // â˜…â˜…â˜… æœ€é‡è¦ï¼â˜…â˜…â˜…
            body: JSON.stringify(reviewData)
        });
        
        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼:', [...response.headers.entries()]);
        
        const result = await response.json();
        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', result);
        
        if (response.status === 401) {
            console.error('âŒ 401 Unauthorized - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼');
            alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
            closeReviewModal();
            setTimeout(() => window.location.reload(), 1000);
            return;
        }
        
        if (result.success) {
            console.log('âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿æˆåŠŸ');
            alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼');
            closeReviewModal();
            
            // ã‚¹ãƒãƒƒãƒˆè©³ç´°ã‚’å†èª­ã¿è¾¼ã¿
            if (currentSpot && currentSpot.id === currentSpotForReview.id) {
                showSpotDetail(currentSpot);
            }
        } else {
            console.error('âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿å¤±æ•—:', result.message);
            alert(result.message || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            submitBtn.disabled = false;
            submitBtn.textContent = 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿';
        }
    } catch (error) {
        console.error('âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿';
    }
    
    console.log('='.repeat(60));
}//å¤‰æ›´
    
    // ã‚¹ãƒãƒƒãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ã‚’å–å¾—
    function loadSpotReviews(spotId, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      container.innerHTML = '<div class="review-loading">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      fetch(`/api/reviews/spot/${spotId}`, {
        credentials: 'include' //è¿½è¨˜11/16
      })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            displayReviews(result, container);
          } else {
            container.innerHTML = '<div class="no-reviews">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
          }
        })
        .catch(error => {
          console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          container.innerHTML = '<div class="no-reviews">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }
    
    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    function displayReviews(data, container) {
      let html = '';
      
      if (data.count > 0) {
        const stars = 'â˜…'.repeat(Math.round(data.average_rating)) + 'â˜†'.repeat(5 - Math.round(data.average_rating));
        html += `
          <div class="average-rating">
            <span class="rating-number">${data.average_rating}</span>
            <span class="rating-stars">${stars}</span>
            <span class="rating-count">(${data.count}ä»¶)</span>
          </div>
        `;
      }
      
      html += '<div class="reviews-section-title">ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§</div>';
      html += '<div class="reviews-list">';
      
      if (data.reviews.length === 0) {
        html += '<div class="no-reviews">ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</div>';
      } else {
        data.reviews.forEach(review => {
          const stars = 'â˜…'.repeat(review.rating) + 'â˜†'.repeat(5 - review.rating);
          const date = new Date(review.created_at).toLocaleDateString('ja-JP');
          const visitDate = review.visit_date ? new Date(review.visit_date).toLocaleDateString('ja-JP') : null;
          
          html += `
            <div class="review-item">
              <div class="review-header">
                <span class="review-user">${review.user_name || 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼'}</span>
                <span class="review-date">${date}</span>
              </div>
              <div class="review-stars">${stars}</div>
              ${review.comment ? `<div class="review-comment">${review.comment}</div>` : ''}
              ${visitDate ? `<div class="review-visit-date">è¨ªå•æ—¥: ${visitDate}</div>` : ''}
            </div>
          `;
        });
      }
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // ã‚¹ãƒãƒƒãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®ã‚¢ã‚¤ã‚³ãƒ³è‰²è¨­å®š
    function getMarkerColor(type) {
      const colors = {
        'åŸ': '#8B4513',
        'å¯ºé™¢': '#FF6347',
        'ç¥ç¤¾': '#FF4500',
        'åšç‰©é¤¨': '#4682B4',
        'ç¾è¡“é¤¨': '#6A5ACD',
        'ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯': '#FF1493',
        'ä¸–ç•Œéºç”£': '#DAA520',
        'å…¬åœ’': '#32CD32',
        'åŠ‡å ´': '#A0522D',
        'é£²é£Ÿåº—': '#FFA500',
        'å›³æ›¸é¤¨': '#20B2AA',
        'æ˜ ç”»é¤¨': '#708090',
        'ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ¼ã‚¯': '#00CED1',
        'å‹•ç‰©åœ’': 'red',
        'æ°´æ—é¤¨': '#1E90FF',
        'å±•æœ›å°': '#2E8B57',
        'è¦³å…‰åœ°': '#7B68EE',
        'å¯ºç¤¾': '#B22222',
        //2025/11/12è¿½è¨˜
        'ã‚³ãƒ³ãƒ“ãƒ‹': '#4CAF50',
        'ãƒˆã‚¤ãƒ¬': '#9C27B0',
        'é§è»Šå ´': '#795548',
        'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³': '#FF5722',
        'ã‚«ãƒ•ã‚§': '#FF9800',
        'è¦³å…‰æ¡ˆå†…æ‰€': '#00BCD4',
        'é‰„é“é§…': '#F44336',
        'ãƒã‚¹åœ': '#FFC107',
        //ã“ã“ã¾ã§
        'ãã®ä»–': '#808080',
        'other': '#808080'
      };
      return colors[type] || colors['other'];
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ä½œæˆ
    function createCustomIcon(type) {
      const color = getMarkerColor(type);
      return L.divIcon({
        className: 'custom-icon',
        html: `<div style="
          background-color: ${color};
          width: 12px;
          height: 12px;
          border-radius: 50%;
          border: 2px solid white;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [12, 12],
        iconAnchor: [6, 6]
      });
    }
    
    // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }

    // å‘¨è¾ºæ–½è¨­ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    function clearFacilityMarkers() {
      facilityMarkers.forEach(marker => map.removeLayer(marker));
      facilityMarkers = [];
    }
    
    // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
    function displayMarkers(spots, searchType) {
      if (spots.length === 0) {
        alert('è©²å½“ã™ã‚‹ã‚¹ãƒãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }
      
      spots.forEach(function(spot) {
        const icon = createCustomIcon(spot.type);
        var marker = L.marker([spot.lat, spot.lon], { icon: icon }).addTo(map);
        markers.push(marker);
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
        var popupContent = `
          <div>
            <div class="popup-title">${spot.name}</div>
            <span class="popup-type">${spot.type}</span>
            <button class="popup-detail-btn" onclick='showSpotDetail(${JSON.stringify(spot).replace(/'/g, "&apos;")})'>
              è©³ç´°ã‚’è¦‹ã‚‹
            </button>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        
        // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
        marker.on('click', function() {
          setTimeout(() => showSpotDetail(spot), 100);
        });
      });
      
      if (spots.length > 0) {
        map.setView([spots[0].lat, spots[0].lon], 12);
      }
    }
    
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢å®Ÿè¡Œ
    function searchSpots() {
      const query = searchInput.value.trim();
      
      if (!query) {
        alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      clearMarkers();
      loading.classList.add('active');
      resultInfo.textContent = 'æ¤œç´¢ä¸­...';
      
      fetch(`/api/search-spots?query=${encodeURIComponent(query)}`, {
        credentials: 'include' //è¿½è¨˜11/16
      })
        .then(response => response.json())
        .then(result => {
          loading.classList.remove('active');
          
          if (!result.success) {
            alert('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            resultInfo.textContent = 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ';
            return;
          }
          
          resultInfo.textContent = `ã€Œ${result.query}ã€ã®æ¤œç´¢çµæœ: ${result.count}ä»¶`;
          displayMarkers(result.spots, 'keyword');
        })
        .catch(error => {
          loading.classList.remove('active');
          console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    
    // ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢å®Ÿè¡Œ
    function searchByCategory() {
      const category = categorySelect.value;
      
      if (!category) {
        alert('ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      clearMarkers();
      loading.classList.add('active');
      resultInfo.textContent = 'ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢ä¸­...';
      
      fetch(`/api/search-by-category?category=${encodeURIComponent(category)}`,{
        credentials: 'include' //è¿½è¨˜11/16
      })
        .then(response => response.json())
        .then(result => {
          loading.classList.remove('active');
          
          if (!result.success) {
            alert('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            resultInfo.textContent = 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ';
            return;
          }
          
          resultInfo.textContent = `ã‚«ãƒ†ã‚´ãƒªã€Œ${result.category_name}ã€ã®æ¤œç´¢çµæœ: ${result.count}ä»¶`;
          displayMarkers(result.spots, 'category');
        })
        .catch(error => {
          loading.classList.remove('active');
          console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    
    // æ¤œç´¢ã‚¯ãƒªã‚¢
    function clearSearch() {
      searchInput.value = '';
      categorySelect.value = '';
      clearMarkers();
      clearFacilityMarkers(); //2025/11/12è¿½è¨˜
      closeSidePanel();
      resultInfo.textContent = 'æ¤œç´¢ã—ã¦ã‚¹ãƒãƒƒãƒˆã‚’è¡¨ç¤º';
      map.setView([34.8, 135.5], 9);
    }
    
    // Overpass API ã‹ã‚‰è¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤º
    function loadOverpassSpots() {
      loading.classList.add('active');
      resultInfo.textContent = 'è¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...';

      fetch('/api/overpass-spots',{
        credentials: 'include' //è¿½è¨˜11/16
      })
        .then(response => response.json())
        .then(result => {
          loading.classList.remove('active');
          if (result.success) {
            resultInfo.textContent = `è¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (${result.count}ä»¶)`;
            displayMarkers(result.spots, 'overpass');
          } else {
            alert(result.message);
            resultInfo.textContent = 'ã‚¹ãƒãƒƒãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
          }
        })
        .catch(error => {
          loading.classList.remove('active');
          console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    //2025/11/12è¿½è¨˜
    // å‘¨è¾ºæ–½è¨­æ¤œç´¢
    function searchNearbyFacilities(lat, lon) {
      clearFacilityMarkers();
      loading.classList.add('active');
      resultInfo.textContent = 'å‘¨è¾ºæ–½è¨­ã‚’æ¤œç´¢ä¸­...';
      
      fetch(`/api/nearby-facilities?lat=${lat}&lon=${lon}&radius=500`,{
        credentials: 'include' //è¿½è¨˜11/16
      })
        .then(response => response.json())
        .then(result => {
          loading.classList.remove('active');
          
          if (!result.success) {
            alert('å‘¨è¾ºæ–½è¨­ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
            return;
          }
          
          resultInfo.textContent = `å‘¨è¾ºæ–½è¨­: ${result.count}ä»¶ã‚’è¡¨ç¤ºä¸­`;
          
          // å‘¨è¾ºæ–½è¨­ã‚’ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
          result.facilities.forEach(function(facility) {
            const icon = createCustomIcon(facility.type);
            var marker = L.marker([facility.lat, facility.lon], { icon: icon }).addTo(map);
            facilityMarkers.push(marker);
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
            var popupContent = `
              <div>
                <div class="popup-title">${facility.name}</div>
                <span class="popup-type">${facility.type}</span>
                ${facility.address ? `<p style="margin-top: 8px; font-size: 13px;">${facility.address}</p>` : ''}
              </div>
            `;
            
            marker.bindPopup(popupContent);
          });
          
          // åœ°å›³ã®ä¸­å¿ƒã‚’æ¤œç´¢åœ°ç‚¹ã«ç§»å‹•
          map.setView([lat, lon], 15);
          
          alert(`å‘¨è¾ºã« ${result.count}ä»¶ã®æ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼`);
        })
        .catch(error => {
          loading.classList.remove('active');
          console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }

    //2025/11/13è¿½è¨˜
    // è·é›¢æ¸¬å®šãƒ„ãƒ¼ãƒ«
    function toggleMeasureTool(event) {

      if (event) {
        event.stopPropagation();
      }

      const btn = document.getElementById('measure-btn');
      isMeasuring = !isMeasuring;
      
      if (isMeasuring) {
        btn.classList.add('active');
        btn.textContent = 'âœ“ æ¸¬å®šä¸­ï¼ˆã‚¯ãƒªã‚¢ï¼‰';
        map.getContainer().style.cursor = 'crosshair';
        //11/13è¿½åŠ 
        resultInfo.textContent = 'åœ°å›³ä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¸¬å®šã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
      setTimeout(() => {
        startMeasuring();
      }, 100);
      } else {
        btn.classList.remove('active');
        btn.textContent = 'ğŸ“ è·é›¢æ¸¬å®š';
        map.getContainer().style.cursor = '';
        clearMeasuring();
      }
    }

    function startMeasuring() {
      map.on('click', onMapClickForMeasure);
    }

    function onMapClickForMeasure(e) {
      if (!isMeasuring) return;
      
      const point = e.latlng;
      const pointIndex = measurePoints.length; //ãƒãƒ¼ã‚«ãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      measurePoints.push(point);
      
      // æ¸¬å®šç‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
      const marker = L.marker(point, {
        icon: L.divIcon({
          className: 'measure-marker',
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        }),
        draggable: true //ã“ã‚Œã§ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
      }).addTo(map);
      measureMarkers.push(marker);

      //ã“ã‚Œã§ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ã—ãŸæ™‚ã®å‡¦ç†å¯èƒ½ã«ãªã‚‹2025/11/13
      marker.on('drag',function(e){
        const newLatLng = e.target.getLatLng();
        measurePoints[pointIndex] = newLatLng;
        updateMeasureLines();
      });
      marker.on('dragend',function(e){
        const newLatLng = e.target.getLatLng();
        measurePoints[pointIndex] = newLatLng;
        updateMeasureLines();
      })
      
      // 2ç‚¹ç›®ä»¥é™ã¯ç·šã‚’å¼•ã
      if (measurePoints.length > 1) {
        const prevPoint = measurePoints[measurePoints.length - 2];
        const line = L.polyline([prevPoint, point], {
          color: '#667eea',
          weight: 3,
          opacity: 0.7,
          dashArray: '10, 5'
        }).addTo(map);
        measureLines.push(line);
        
        // è·é›¢ã‚’è¨ˆç®—
        const distance = map.distance(prevPoint, point);
        const totalDistance = calculateTotalDistance();

        
        // è·é›¢ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
        const midPoint = L.latLng(
          (prevPoint.lat + point.lat) / 2,
          (prevPoint.lng + point.lng) / 2
        );
        
        const label = L.marker(midPoint, {
          icon: L.divIcon({
            className: 'distance-label',
            html: `${formatDistance(distance)}<br><small>åˆè¨ˆ: ${formatDistance(totalDistance)}</small>`,
            iconAnchor: [50, 20]
          })
        }).addTo(map);
        measureMarkers.push(label);
        
        // æ­©è¡Œæ™‚é–“ã®æ¦‚ç®—ã‚’è¡¨ç¤º
        const walkingTime = Math.ceil(totalDistance / 80); // æ™‚é€Ÿ4.8km = 80m/åˆ†
        resultInfo.textContent = `æ¸¬å®šä¸­: åˆè¨ˆè·é›¢ ${formatDistance(totalDistance)} (å¾’æ­©ç´„${walkingTime}åˆ†)`;
      } else {
        resultInfo.textContent = 'æ¸¬å®šä¸­: æ¬¡ã®åœ°ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';
      }
    }

    //2025/11/13è¿½è¨˜
      // è·é›¢ã®ç·šã¨ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
      function updateMeasureLines() {
        // æ—¢å­˜ã®ç·šã¨ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
        measureLines.forEach(line => map.removeLayer(line));
        measureLines = [];
        
        // ãƒ©ãƒ™ãƒ«ãƒãƒ¼ã‚«ãƒ¼ã ã‘ã‚’å‰Šé™¤ï¼ˆæ¸¬å®šç‚¹ãƒãƒ¼ã‚«ãƒ¼ã¯æ®‹ã™ï¼‰
        measureMarkers.forEach((marker, index) => {
          // æœ€åˆã®Nå€‹ã¯æ¸¬å®šç‚¹ãƒãƒ¼ã‚«ãƒ¼ãªã®ã§æ®‹ã™
          // ãã‚Œä»¥é™ã¯ãƒ©ãƒ™ãƒ«ãªã®ã§å‰Šé™¤
          if (index >= measurePoints.length) {
            map.removeLayer(marker);
          }
        });
        // ãƒ©ãƒ™ãƒ«åˆ†ã‚’å‰Šé™¤
        measureMarkers = measureMarkers.slice(0, measurePoints.length);
        
        // æ–°ã—ã„ç·šã¨ãƒ©ãƒ™ãƒ«ã‚’æç”»
        for (let i = 1; i < measurePoints.length; i++) {
          const prevPoint = measurePoints[i - 1];
          const point = measurePoints[i];
          
          // ç·šã‚’æç”»
          const line = L.polyline([prevPoint, point], {
            color: '#667eea',
            weight: 3,
            opacity: 0.7,
            dashArray: '10, 5'
          }).addTo(map);
          measureLines.push(line);
          
          // è·é›¢ã‚’è¨ˆç®—
          const distance = map.distance(prevPoint, point);
          const totalDistance = calculateTotalDistance();
          
          // è·é›¢ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
          const midPoint = L.latLng(
            (prevPoint.lat + point.lat) / 2,
            (prevPoint.lng + point.lng) / 2
          );
          
          const label = L.marker(midPoint, {
            icon: L.divIcon({
              className: 'distance-label',
              html: `${formatDistance(distance)}<br><small>åˆè¨ˆ: ${formatDistance(totalDistance)}</small>`,
              iconAnchor: [50, 20]
            })
          }).addTo(map);
          measureMarkers.push(label);
        }
        
        // åˆè¨ˆè·é›¢ã‚’è¡¨ç¤º
        const totalDistance = calculateTotalDistance();
        const walkingTime = Math.ceil(totalDistance / 80);
        resultInfo.textContent = `æ¸¬å®šä¸­: åˆè¨ˆè·é›¢ ${formatDistance(totalDistance)} (å¾’æ­©ç´„${walkingTime}åˆ†)`;
      } //ã“ã“ã¾ã§

    function calculateTotalDistance() {
      let total = 0;
      for (let i = 1; i < measurePoints.length; i++) {
        total += map.distance(measurePoints[i - 1], measurePoints[i]);
      }
      return total;
    }

    function formatDistance(meters) {
      if (meters < 1000) {
        return Math.round(meters) + 'm';
      } else {
        return (meters / 1000).toFixed(2) + 'km';
      }
    }

    function clearMeasuring() {
      map.off('click', onMapClickForMeasure);
      
      // ã™ã¹ã¦ã®æ¸¬å®šãƒãƒ¼ã‚«ãƒ¼ã¨ç·šã‚’å‰Šé™¤
      measureMarkers.forEach(marker => map.removeLayer(marker));
      measureLines.forEach(line => map.removeLayer(line));
      
      measurePoints = [];
      measureMarkers = [];
      measureLines = [];
      
      if (!isMeasuring) {
        resultInfo.textContent = 'æ¤œç´¢ã—ã¦ã‚¹ãƒãƒƒãƒˆã‚’è¡¨ç¤º';
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ã§Overpassã‚¹ãƒãƒƒãƒˆã‚’å–å¾—
    window.addEventListener('load', loadOverpassSpots);
  </script>
</body>
</html>
